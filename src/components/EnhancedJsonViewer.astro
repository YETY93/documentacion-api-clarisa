---
import EndpointDisplay from "./EndpointDisplay.astro";

export interface Props {
  code: string;
  title?: string;
  isMainRequest?: boolean;
  method?: string;
  endpoint_prod?: string;
  endpoint_qa?: string;
}

const {
  code,
  title = "JSON",
  isMainRequest = false,
  method,
  endpoint_prod,
  endpoint_qa
} = Astro.props;

let formattedJson = code;
let isValidJson = false;
try {
  const parsed = JSON.parse(code);
  formattedJson = JSON.stringify(parsed, null, 2);
  isValidJson = true;
} catch (e) {
  // No es un JSON válido, se mostrará como texto plano.
}

const uniqueId = `json-code-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="enhanced-json-viewer mb-6 border border-gray-200 dark:border-slate-700 rounded-lg overflow-hidden shadow-sm">

  <div class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 px-4 py-3">
    <div class="flex items-center space-x-3">
      <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">{title}</span>
    </div>
    <div class="flex items-center space-x-2">
      {isValidJson && <span class="text-xs text-green-600 dark:text-green-400">✓ Válido</span>}
      <button
        class="copy-btn flex items-center space-x-1 px-3 py-1.5 text-xs bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded hover:bg-gray-50 dark:hover:bg-gray-500 shadow-sm"
        data-target={uniqueId}
        title="Copiar JSON"
      >
        <span class="copy-text">Copiar</span>
      </button>
    </div>
  </div>

  <div class="code-container text-sm relative">
    <pre class="line-numbers language-json !m-0 !p-4 !bg-transparent"><code id={uniqueId}>{formattedJson}</code></pre>
  </div>
</div>

<script>
  import Prism from 'prismjs';
  import 'prismjs/components/prism-json';
  import 'prismjs/plugins/line-numbers/prism-line-numbers.js';

  function initializePrism() {
    document.querySelectorAll('.copy-btn').forEach(button => {
      const newButton = button.cloneNode(true) as HTMLElement;
      button.parentNode?.replaceChild(newButton, button);

      newButton.addEventListener('click', async () => {
        const targetId = newButton.getAttribute('data-target');
        const codeElement = targetId ? document.getElementById(targetId) : null;
        const copyTextSpan = newButton.querySelector('.copy-text');
        const originalText = 'Copiar';

        if (codeElement && copyTextSpan) {
          try {
            await navigator.clipboard.writeText(codeElement.textContent || '');
            copyTextSpan.textContent = '¡Copiado!';
            newButton.classList.add('!bg-green-500', '!text-white');

            setTimeout(() => {
              copyTextSpan.textContent = originalText;
              newButton.classList.remove('!bg-green-500', '!text-white');
            }, 2000);
          } catch (error) {
            console.error('Error al copiar:', error);
            copyTextSpan.textContent = 'Error';
            setTimeout(() => { copyTextSpan.textContent = originalText; }, 2000);
          }
        }
      });
    });
    
    Prism.highlightAll();
  }

  document.addEventListener('astro:page-load', initializePrism);
  initializePrism();
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

<style>
  .code-container {
    background-color: #f9fafb;
  }

  :global(html.dark) .code-container {
    background-color: #1f2937;
  }

  :global(pre[class*="language-"]) {
    background: transparent !important;
    margin: 0 !important;
    padding: 1rem !important;
    overflow: auto;
    border: none !important;
    color: #1f2937;
  }

  :global(html.dark pre[class*="language-"]) {
    color: #e5e7eb;
  }

  :global(pre.line-numbers) {
    padding-left: 3.8rem !important;
  }

  :global(.token.property),
  :global(.token.tag),
  :global(.token.boolean),
  :global(.token.number),
  :global(.token.constant),
  :global(.token.symbol) {
    color: #0451a5;
  }

  :global(html.dark .token.property),
  :global(html.dark .token.tag),
  :global(html.dark .token.boolean),
  :global(html.dark .token.number),
  :global(html.dark .token.constant),
  :global(html.dark .token.symbol) {
    color: #9cdcfe;
  }

  :global(.token.string),
  :global(.token.char),
  :global(.token.attr-value) {
    color: #a31515;
  }

  :global(html.dark .token.string),
  :global(html.dark .token.char),
  :global(html.dark .token.attr-value) {
    color: #ce9178;
  }

  :global(.token.punctuation) {
    color: #000000;
  }

  :global(html.dark .token.punctuation) {
    color: #d4d4d4;
  }
</style>
