---
// src/components/UniversalMarkdownProcessor.astro
import EnhancedJsonViewer from "./EnhancedJsonViewer.astro";
import JsonSummary from "./JsonSummary.astro";
import { marked } from "marked";

export interface Props {
    content: string;
    method?: string;
    endpoint_prod?: string;
    endpoint_qa?: string;
}

const { content, method, endpoint_prod, endpoint_qa } = Astro.props;

// Configurar marked para mejor renderizado
marked.setOptions({
    breaks: true,
    gfm: true,
});

// Función para detectar el tipo de JSON basado en contexto
function detectJsonType(beforeContext: string, jsonContent: string) {
    const context = beforeContext.toLowerCase();
    
    // Título por defecto
    let title = "Ejemplo JSON";

    // Bandera para identificar si es el bloque principal
    let isMainRequest = false;

    // Lógica de detección de títulos
    if (context.includes("estructura de la petición")) {
        title = "Estructura de la Petición";
        isMainRequest = true;
    } else if (context.includes("respuesta esperada")) {
        title = "Respuesta Esperada";
    } else if (context.includes("múltiples impuestos")) {
        title = "Ejemplo: Múltiples Impuestos";
    } else if (context.includes("descuento por ítem")) {
        title = "Ejemplo: Descuento por Ítem";
    } else if (context.includes("descuento general")) {
        title = "Ejemplo: Descuento General";
    } else if (context.includes("respuesta de error")) {
        title = "Ejemplo: Respuesta de Error";
    }

    // Intenta parsear para refinar
    try {
        const parsed = JSON.parse(jsonContent);
        if (parsed.items && parsed.cliente && !isMainRequest) {
            title = "Estructura de la Petición";
            isMainRequest = true;
        }
    } catch (e) {}

    return { title, isMainRequest };
}

// Función para procesar el markdown y extraer bloques de código
function processMarkdownContent(markdownContent: string) {
    const parts = [];
    let currentIndex = 0;
    const codeBlockRegex = /```(json|http|javascript|bash|shell|text)\n([\s\S]*?)\n```/g;
    let match;

    while ((match = codeBlockRegex.exec(markdownContent)) !== null) {
        // Contenido antes del bloque
        if (match.index > currentIndex) {
            const beforeContent = markdownContent.slice(currentIndex, match.index);
            parts.push({ type: "markdown", content: marked.parse(beforeContent) });
        }

        const lang = match[1];
        const codeContent = match[2];

        if (lang === 'json') {
            const beforeContext = markdownContent.slice(Math.max(0, match.index - 400), match.index);
            const { title, isMainRequest } = detectJsonType(beforeContext, codeContent);

            parts.push({
                type: "json",
                content: codeContent,
                title: title,
                isMainRequest: isMainRequest
            });
        } else {
             parts.push({ type: 'other_code', content: codeContent, lang });
        }

        currentIndex = match.index + match[0].length;
    }

    // Contenido restante
    if (currentIndex < markdownContent.length) {
        parts.push({ type: "markdown", content: marked.parse(markdownContent.slice(currentIndex)) });
    }

    return parts;
}

const processedParts = processMarkdownContent(content);
const hasJsonBlocks = processedParts.some(part => part.type === "json");
---

<div class="universal-markdown-processor">
    {hasJsonBlocks && <JsonSummary content={content} />}

    {
        processedParts.map((part) => {
            if (part.type === "json") {
                return (
                    <div class="not-prose">
                        <EnhancedJsonViewer
                            code={part.content}
                            title={part.title}
                            isMainRequest={part.isMainRequest}
                            method={method}
                            endpoint_prod={endpoint_prod}
                            endpoint_qa={endpoint_qa}
                        />
                    </div>
                );
            } else if (part.type === 'other_code') {
                // Renderiza otros bloques de código si es necesario (puedes usar un componente genérico aquí)
                return <pre><code>{part.content}</code></pre>;
            } else {
                return <div set:html={part.content} />;
            }
        })
    }
</div>
