---
// src/components/SidebarMenu.astro
import { getCollection } from 'astro:content';

const allDocs = await getCollection('docs');
const categories = [...new Set(allDocs.map(doc => doc.data.category))];

// Obtener la URL actual para marcar el elemento activo
const { pathname } = Astro.url;
const currentPath = pathname.replace(/\/$/, '') || '/'; // Remover slash final

// Función para verificar si un enlace está activo
function isActiveLink(linkPath: string): boolean {
  if (currentPath === '/' && linkPath === '/') return true;
  if (linkPath === '/') return false;
  return currentPath.includes(linkPath) || currentPath.endsWith(linkPath);
}

// Función para generar la URL del documento
function getDocUrl(doc: any): string {
  return `/${encodeURIComponent(doc.data.category)}/${doc.slug.split('/').pop()}`;
}
---
<nav class="h-full bg-transparent">
  <!-- Header del sidebar -->
  <div class="p-4 border-b border-gray-200/60 dark:border-slate-700/50">
    <h2 class="font-semibold text-gray-900 dark:text-slate-100">Navegación</h2>
  </div>
  
  <!-- Contenido del sidebar -->
  <div class="p-4 overflow-y-auto scrollbar-thin h-[calc(100vh-140px)]">
    <ul class="space-y-6">
      {categories.map(category => {
        const hasActiveDoc = allDocs.filter(doc => doc.data.category === category).some(doc => isActiveLink(getDocUrl(doc)));
        return (
        <li>
          <!-- Categoría con acordeón -->
          <button 
            class={`accordion-toggle w-full flex items-center justify-between mb-2 p-2 rounded-lg transition-all duration-200 hover:bg-gray-50 dark:hover:bg-slate-800/50 ${
              hasActiveDoc
                ? 'bg-clarisa-50 dark:bg-clarisa-900/20'
                : ''
            }`}
            data-category={category}
            aria-expanded={hasActiveDoc ? 'true' : 'false'}
          >
            <div class="flex items-center gap-2">
              <svg 
                class={`accordion-arrow w-4 h-4 transition-transform duration-200 ${
                  hasActiveDoc ? 'rotate-90' : ''
                }`}
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <h3 class={`font-medium text-sm uppercase tracking-wide transition-colors ${
                hasActiveDoc
                  ? 'text-clarisa-700 dark:text-clarisa-300'
                  : 'text-gray-900 dark:text-slate-100'
              }`}>
                {category}
              </h3>
            </div>
            <span class={`text-xs px-2 py-1 rounded transition-colors ${
              hasActiveDoc
                ? 'text-clarisa-600 bg-clarisa-100 dark:bg-clarisa-800/50 dark:text-clarisa-300'
                : 'text-gray-500 bg-gray-100 dark:bg-slate-800/50 dark:text-slate-300'
            }`}>
              {allDocs.filter(doc => doc.data.category === category).length}
            </span>
          </button>
          
          <!-- Items de la categoría -->
          <ul 
            class={`accordion-content space-y-1 border-l border-gray-200 dark:border-slate-600/50 ml-1 pl-3 overflow-hidden transition-all duration-200 ${
              hasActiveDoc ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'
            }`}
            data-category={category}
          >
            {allDocs
              .filter(doc => doc.data.category === category)
              .map(doc => {
                const docUrl = getDocUrl(doc);
                const isActive = isActiveLink(docUrl);
                return (
                  <li>
                    <a 
                      href={docUrl}
                      class={`block text-sm px-2 py-1.5 rounded transition-colors relative ${
                        isActive 
                          ? 'text-clarisa-600 dark:text-clarisa-400 bg-clarisa-50 dark:bg-clarisa-900/30 font-medium border-l-2 border-clarisa-500 -ml-3 pl-4' 
                          : 'text-gray-600 dark:text-slate-300 hover:text-clarisa-600 dark:hover:text-clarisa-400 hover:bg-gray-50 dark:hover:bg-slate-800/50'
                      }`}
                    >
                      {isActive && (
                        <span class="absolute left-0 top-0 bottom-0 w-0.5 bg-clarisa-500 rounded-r"></span>
                      )}
                      {doc.data.title}
                    </a>
                  </li>
                );
              })
            }
          </ul>
        </li>
      )})}
    </ul>
    
    <!-- Enlaces útiles -->
    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-slate-600/50">
      <h3 class="font-medium text-gray-900 dark:text-slate-100 text-sm uppercase tracking-wide mb-3">
        Enlaces útiles
      </h3>
      <ul class="space-y-1">
        <li>
          <a 
            href="/getting-started" 
            class={`block text-sm px-2 py-1.5 rounded transition-colors ${
              isActiveLink('/getting-started')
                ? 'text-clarisa-600 dark:text-clarisa-400 bg-clarisa-50 dark:bg-clarisa-900/30 font-medium'
                : 'text-gray-600 dark:text-slate-300 hover:text-clarisa-600 dark:hover:text-clarisa-400 hover:bg-gray-50 dark:hover:bg-slate-800/50'
            }`}
          >
            🚀 Comenzar
          </a>
        </li>
        <li>
          <a 
            href="/authentication" 
            class={`block text-sm px-2 py-1.5 rounded transition-colors ${
              isActiveLink('/authentication')
                ? 'text-clarisa-600 dark:text-clarisa-400 bg-clarisa-50 dark:bg-clarisa-900/30 font-medium'
                : 'text-gray-600 dark:text-slate-300 hover:text-clarisa-600 dark:hover:text-clarisa-400 hover:bg-gray-50 dark:hover:bg-slate-800/50'
            }`}
          >
            🔐 Autenticación
          </a>
        </li>
        <li>
          <a 
            href="/examples" 
            class={`block text-sm px-2 py-1.5 rounded transition-colors ${
              isActiveLink('/examples')
                ? 'text-clarisa-600 dark:text-clarisa-400 bg-clarisa-50 dark:bg-clarisa-900/30 font-medium'
                : 'text-gray-600 dark:text-slate-300 hover:text-clarisa-600 dark:hover:text-clarisa-400 hover:bg-gray-50 dark:hover:bg-slate-800/50'
            }`}
          >
            📝 Ejemplos
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<script is:inline>
  (function() {
    if (window.sidebarInitialized) return;
    window.sidebarInitialized = true;

    function initAccordion() {
      const accordionToggles = document.querySelectorAll('.accordion-toggle');
      
      accordionToggles.forEach(toggle => {
        if (toggle.hasAttribute('data-initialized')) return;
        toggle.setAttribute('data-initialized', 'true');
        
        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          const category = toggle.dataset.category;
          const content = document.querySelector(`.accordion-content[data-category="${category}"]`);
          const arrow = toggle.querySelector('.accordion-arrow');
          const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
          
          if (isExpanded) {
            toggle.setAttribute('aria-expanded', 'false');
            arrow.classList.remove('rotate-90');
            content.classList.remove('max-h-96', 'opacity-100');
            content.classList.add('max-h-0', 'opacity-0');
          } else {
            toggle.setAttribute('aria-expanded', 'true');
            arrow.classList.add('rotate-90');
            content.classList.remove('max-h-0', 'opacity-0');
            content.classList.add('max-h-96', 'opacity-100');
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAccordion);
    } else {
      initAccordion();
    }
  })();
</script>

<style>
  /* Animación suave para el indicador activo */
  nav a {
    position: relative;
    transition: all 0.2s ease-in-out;
  }

  /* Efecto hover mejorado */
  nav a:hover:not(.text-clarisa-600) {
    transform: translateX(2px);
  }

  /* Indicador visual para elemento activo */
  nav a.text-clarisa-600::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 16px;
    background: linear-gradient(135deg, #2583c6, #1e40af);
    border-radius: 2px;
    opacity: 0.8;
  }

  /* Scroll suave para el sidebar */
  .overflow-y-auto {
    scroll-behavior: smooth;
  }


</style>