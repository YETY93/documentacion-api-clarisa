---
export interface Props {
  code: string;
  language: string;
  title?: string;
}

const { code, language, title } = Astro.props;
const uniqueId = `code-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="code-viewer mb-6 border border-gray-200 dark:border-slate-700 rounded-lg overflow-hidden shadow-sm">
  <div class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 px-4 py-3">
    <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">{title}</span>
    <button
      class="copy-btn flex items-center space-x-1 px-3 py-1.5 text-xs bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded hover:bg-gray-50 dark:hover:bg-gray-500 shadow-sm"
      data-target={uniqueId}
      title="Copiar código"
    >
      <span class="copy-text">Copiar</span>
    </button>
  </div>

  <div class="code-container text-sm relative">
    <pre class={`language-${language} !m-0 !p-4 !bg-transparent`}><code id={uniqueId}>{code}</code></pre>
  </div>
</div>

<script>
  import Prism from 'prismjs';
  import 'prismjs/components/prism-bash';
  import 'prismjs/components/prism-javascript';
  import 'prismjs/components/prism-python';

  function initCodeViewer() {
    document.querySelectorAll('.copy-btn').forEach(button => {
      const newButton = button.cloneNode(true) as HTMLElement;
      button.parentNode?.replaceChild(newButton, button);

      newButton.addEventListener('click', async () => {
        const targetId = newButton.getAttribute('data-target');
        const codeElement = targetId ? document.getElementById(targetId) : null;
        const copyTextSpan = newButton.querySelector('.copy-text');

        if (codeElement && copyTextSpan) {
          try {
            await navigator.clipboard.writeText(codeElement.textContent || '');
            copyTextSpan.textContent = '¡Copiado!';
            newButton.classList.add('!bg-green-500', '!text-white');

            setTimeout(() => {
              copyTextSpan.textContent = 'Copiar';
              newButton.classList.remove('!bg-green-500', '!text-white');
            }, 2000);
          } catch (error) {
            console.error('Error al copiar:', error);
          }
        }
      });
    });

    Prism.highlightAll();
  }

  document.addEventListener('astro:page-load', initCodeViewer);
  initCodeViewer();
</script>

<style>
  .code-container {
    background-color: #f9fafb;
  }

  :global(html.dark) .code-container {
    background-color: #1f2937;
  }

  :global(pre[class*="language-"]) {
    background: transparent !important;
    margin: 0 !important;
    padding: 1rem !important;
    overflow: auto;
    border: none !important;
    color: #1f2937;
  }

  :global(html.dark pre[class*="language-"]) {
    color: #e5e7eb;
  }

  /* Tema claro - colores vibrantes */
  :global(.token.comment),
  :global(.token.prolog),
  :global(.token.doctype),
  :global(.token.cdata) {
    color: #6b7280;
  }

  :global(.token.punctuation) {
    color: #374151;
  }

  :global(.token.property),
  :global(.token.tag),
  :global(.token.boolean),
  :global(.token.number),
  :global(.token.constant),
  :global(.token.symbol) {
    color: #0369a1;
  }

  :global(.token.selector),
  :global(.token.attr-name),
  :global(.token.string),
  :global(.token.char),
  :global(.token.builtin) {
    color: #b91c1c;
  }

  :global(.token.operator),
  :global(.token.entity),
  :global(.token.url),
  :global(.token.variable) {
    color: #b45309;
  }

  :global(.token.atrule),
  :global(.token.attr-value),
  :global(.token.function),
  :global(.token.class-name) {
    color: #7c3aed;
  }

  :global(.token.keyword) {
    color: #be185d;
  }

  :global(.token.regex),
  :global(.token.important) {
    color: #ea580c;
  }

  /* Tema oscuro */
  :global(html.dark .token.comment),
  :global(html.dark .token.prolog),
  :global(html.dark .token.doctype),
  :global(html.dark .token.cdata) {
    color: #9ca3af;
  }

  :global(html.dark .token.punctuation) {
    color: #d1d5db;
  }

  :global(html.dark .token.property),
  :global(html.dark .token.tag),
  :global(html.dark .token.boolean),
  :global(html.dark .token.number),
  :global(html.dark .token.constant),
  :global(html.dark .token.symbol) {
    color: #60a5fa;
  }

  :global(html.dark .token.selector),
  :global(html.dark .token.attr-name),
  :global(html.dark .token.string),
  :global(html.dark .token.char),
  :global(html.dark .token.builtin) {
    color: #f87171;
  }

  :global(html.dark .token.operator),
  :global(html.dark .token.entity),
  :global(html.dark .token.url),
  :global(html.dark .token.variable) {
    color: #fb923c;
  }

  :global(html.dark .token.atrule),
  :global(html.dark .token.attr-value),
  :global(html.dark .token.function),
  :global(html.dark .token.class-name) {
    color: #a78bfa;
  }

  :global(html.dark .token.keyword) {
    color: #f472b6;
  }

  :global(html.dark .token.regex),
  :global(html.dark .token.important) {
    color: #fb923c;
  }
</style>
