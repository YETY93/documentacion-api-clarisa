---
// src/layouts/MainLayout.astro
import Header from "../components/Header.astro";
import SidebarMenu from "../components/SidebarMenu.astro";
import CodePanel from "../components/CodePanel.astro";
import "../styles/global.css";

export interface Props {
  title: string;
  method?: string;
  endpoint_prod?: string;
  endpoint_qa?: string;
  response_code?: number;
  response_success?: string;
  response_code_error?: number[];
  response_error?: string;
}

const { title, method, endpoint_prod, endpoint_qa, response_code, response_success, response_code_error, response_error } = Astro.props;
---
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    
    {/* SCRIPT ANTI-PARPADEO: Se ejecuta antes de que la página se pinte */}
    <script is:inline>
      const theme = (() => {
        // 1. Revisa si el usuario ya guardó una preferencia
        if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
          return localStorage.getItem("theme");
        }
        // 2. Si no, revisa la preferencia del sistema operativo
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        // 3. Por defecto, usa el tema claro
        return "light";
      })();

      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
      
      // Sincroniza el tema con el navegador para elementos como el scrollbar
      document.documentElement.style.colorScheme = theme;
    </script>
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    
    {/* Estilos para una transición de tema suave */}
    <style>
      *, *::before, *::after {
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      }
    </style>
  </head>
  <body
    class="h-full bg-gray-50 dark:bg-gradient-to-br dark:from-slate-900 dark:via-slate-800 dark:to-clarisa-950 text-slate-900 dark:text-slate-100"
  >
    <header
      class="bg-gradient-to-r from-clarisa-800 to-clarisa-700 dark:from-slate-900/95 dark:via-clarisa-950/90 dark:to-clarisa-900/95 text-white shadow-lg fixed top-0 left-0 right-0 z-50 border-b border-clarisa-600/30 dark:border-clarisa-500/20 backdrop-blur-sm"
    >
      <div class="h-16 flex items-center">
        <Header />
      </div>
    </header>

    <div class="flex min-h-screen pt-16 w-full relative">
      <aside
        class="hidden lg:flex w-80 bg-white/95 dark:bg-slate-900/80 border-r border-gray-200/60 dark:border-slate-700/50 flex-col flex-shrink-0 backdrop-blur-sm h-[calc(100vh-64px)] sticky top-16"
      >
        <div class="overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
          <SidebarMenu />
        </div>
      </aside>

      <main class="flex-1 bg-white/90 dark:bg-slate-800/60 min-w-0 backdrop-blur-sm min-h-[calc(100vh-64px)] xl:mr-[36rem]">
        <div class="p-4 md:p-6 lg:p-8 max-w-none w-full pb-24 xl:pb-8">
          <slot />
        </div>
      </main>

      <aside
        class="hidden xl:flex w-[36rem] bg-white/95 dark:bg-slate-900/80 border-l border-gray-200/60 dark:border-slate-700/50 flex-col flex-shrink-0 backdrop-blur-sm fixed right-0 top-16 bottom-0 z-20"
      >
        <div class="overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent h-full">
          <CodePanel 
            {method} 
            {endpoint_prod} 
            {endpoint_qa} 
            response_code={response_code} 
            response_success={response_success} 
            response_code_error={response_code_error} 
            response_error={response_error} 
          />
        </div>
      </aside>
    </div>

    <!-- Menú lateral móvil -->
    <div id="mobile-sidebar-overlay" class="lg:hidden fixed inset-0 z-40 hidden">
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="mobile-overlay"></div>
      <div
        class="fixed left-0 top-16 bottom-0 w-80 max-w-[85vw] bg-white/95 dark:bg-slate-900/95 shadow-xl transform -translate-x-full transition-transform duration-300 backdrop-blur-md"
        id="mobile-sidebar"
      >
        <div class="overflow-y-auto h-full scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
          <SidebarMenu />
        </div>
      </div>
    </div>

    <!-- Panel de código flotante (móvil/tablet) -->
    <div id="mobile-code-panel" class="xl:hidden fixed bottom-6 right-6 z-30">
      <button 
        id="code-panel-toggle"
        class="bg-clarisa-600 hover:bg-clarisa-700 dark:bg-clarisa-500 dark:hover:bg-clarisa-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:shadow-xl hover:scale-110 focus:outline-none focus:ring-2 focus:ring-clarisa-400"
        aria-label="Ver ejemplos de código"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
        </svg>
      </button>
      
      <div 
        id="code-panel-content"
        class="fixed bottom-0 right-0 top-16 w-full sm:w-96 bg-white/95 dark:bg-slate-900/95 shadow-2xl transform translate-x-full transition-transform duration-300 ease-out z-40 backdrop-blur-md border-l border-gray-200/60 dark:border-slate-700/50"
      >
        <div class="bg-clarisa-600 dark:bg-clarisa-700 text-white p-4 flex items-center justify-between border-b border-clarisa-500/30">
          <h3 class="font-semibold">Ejemplos de Código</h3>
          <button 
            id="close-panel"
            class="text-white hover:text-gray-200 transition-colors p-1 rounded hover:bg-clarisa-700 dark:hover:bg-clarisa-600"
            aria-label="Cerrar panel"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="h-full overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent pb-20">
          <CodePanel 
            {method} 
            {endpoint_prod} 
            {endpoint_qa} 
            response_code={response_code} 
            response_success={response_success} 
            response_code_error={response_code_error} 
            response_error={response_error} 
          />
        </div>
      </div>
      
      <div 
        id="panel-overlay" 
        class="fixed inset-0 bg-black/50 z-30 hidden transition-opacity duration-300 backdrop-blur-sm"
      ></div>
    </div>

    <script src="../scripts/responsive.js"></script>
  </body>
</html>
